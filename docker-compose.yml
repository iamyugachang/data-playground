services:
  # ---------------------------------------------------------------------------
  # Database Service (Serving both Hive Metastore and Business Data)
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:15
    container_name: data_playground_postgres
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: password
      POSTGRES_DB: postgres # default db
    volumes:
      - ./infrastructure/postgres/init_data.sql:/docker-entrypoint-initdb.d/init_data.sql
    ports:
      - "5432:5432"

  # ---------------------------------------------------------------------------
  # Object Storage (MinIO)
  # ---------------------------------------------------------------------------
  minio:
    image: quay.io/minio/minio:latest
    container_name: data_playground_minio
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: password
      MINIO_DOMAIN: minio
    command: server /data --console-address ":9001"
    networks:
      default:
        aliases:
          - warehouse.minio
    ports:
      - "9000:9000"
      - "9001:9001"
  # ---------------------------------------------------------------------------
  # Apache Polaris (Catalog)
  # ---------------------------------------------------------------------------
  polaris:
    image: apache/polaris:latest
    container_name: data_playground_polaris
    environment:
      - POLARIS_ENV=dev
      - POLARIS_BOOTSTRAP_CREDENTIALS=POLARIS,root,s3cr3t
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=password
      - AWS_ENDPOINT_URL=http://minio:9000
      - AWS_ENDPOINT_URL_S3=http://minio:9000
      - AWS_S3_FORCE_PATH_STYLE=true
      - QUARKUS_S3_PATH_STYLE_ACCESS=true
      - JAVA_TOOL_OPTIONS=-Daws.s3PathStyleAccess=true -Daws.s3.pathStyleAccess=true
    ports:
      - "8181:8181"
    depends_on:
      - postgres

  # ---------------------------------------------------------------------------
  # Trino
  # ---------------------------------------------------------------------------
  trino:
    image: trinodb/trino:latest
    container_name: data_playground_trino
    ports:
      - "8080:8080"
    volumes:
      - ./infrastructure/trino/etc:/etc/trino
      - ./scripts:/scripts
    depends_on:
      - polaris
      - postgres
      - minio

  # ---------------------------------------------------------------------------
  # dbt
  # ---------------------------------------------------------------------------
  dbt:
    build:
      context: .
      dockerfile: infrastructure/dbt/docker/Dockerfile
    container_name: data_playground_dbt_runner
    command: bash -c "until dbt debug; do echo 'Waiting for Trino...'; sleep 5; done; dbt docs generate || echo 'Docs generation failed'; dbt docs serve --port 8081 --host 0.0.0.0 || tail -f /dev/null"
    volumes:
      - ./apps/dbt-analytics:/usr/app/dbt_project
      # Mount profiles locally so they persist and are easy to edit
      - ./infrastructure/dbt/profiles:/root/.dbt
      - ./scripts:/scripts
    environment:
      - DBT_PROFILES_DIR=/root/.dbt
    ports:
      - "8081:8081" # Expose for dbt docs
    depends_on:
      - trino
